<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link type="text/css" rel="styleSheet" href="font.css"/>
  <link type="text/css" rel="styleSheet" href="operator_info.css"/>
  <link type="text/css" rel="styleSheet" href="skill_type.css"/>
  <title>{{ op.name or "operator" }}</title>
</head>

<body>
<div id="template">
  {# -------------------- 小工具：属性展示（基础 + 信赖 + 模组） -------------------- #}
  {% macro render_attr(key, suffix="") -%}
    {# key 传入如 "maxHp" / "atk" 等，与 base_attr dict 的键一致 #}
    {% set base = base_attr.get(key, 0) %}
    {% set trust = trust_attr.get(key, 0) %}
    {% set mod = module_attr.get(key, 0) %}

    {{ base }}
    {%- if trust %}
      <span class="a">+{{ trust }}</span>
    {%- endif %}
    {%- if mod %}
      {# 处理 + - 的显示问题 #}
      <span class="b">{{ ("+" ~ mod) | replace("+-", "-") }}</span>
    {%- endif %}
    {{ suffix }}
  {%- endmacro %}

  <div class="background"
       style="background-image: url('{{ skin_url }}');"
       {% if not op %}hidden{% endif %}>

    <div class="left">
      <div>

        <div class="operator-attr">
          <div class="attr" title="最大生命值">
            <div>{{ render_attr("maxHp") }}</div>
          </div>
          <div class="attr" title="攻击力">
            <div>{{ render_attr("atk") }}</div>
          </div>
          <div class="attr" title="防御力">
            <div>{{ render_attr("def") }}</div>
          </div>
          <div class="attr" title="魔法抗性">
            <div>{{ render_attr("magicResistance") }}</div>
          </div>
          <div class="attr" title="攻击速度">
            <div>{{ render_attr("attackSpeed") }}</div>
          </div>
          <div class="attr" title="攻击间隔">
            <div>{{ render_attr("baseAttackTime") }}</div>
          </div>
          <div class="attr" title="阻挡数">
            <div>{{ render_attr("blockCnt") }}</div>
          </div>
          <div class="attr" title="部署费用">
            <div>{{ render_attr("cost") }}</div>
          </div>
          <div class="attr" title="再部署时间">
            <div>{{ render_attr("respawnTime", "秒") }}</div>
          </div>

          <div class="attr" title="势力">
            <div>{{ op.nation or "未知" }}</div>
          </div>
          <div class="attr" title="阵营">
            <div>{{ op.group or "未知" }}</div>
          </div>
          <div class="attr" title="队伍">
            <div>{{ op.team or "未知" }}</div>
          </div>

          <div class="attr" title="种族">
            <div>{{ op.race or "未知" }}</div>
          </div>
          <div class="attr" title="画师">
            <div>{{ op.drawer or "未知" }}</div>
          </div>
          <div class="attr" title="生日">
            <div>{{ op.birthday or "未知" }}</div>
          </div>
        </div>

        {# --- 潜能（你当前 Operator 领域模型里没放 potentialRanks；如果你后续会传入就显示） --- #}
        {% if potential_list %}
          <div>
            <div class="title" style="width: 120px">潜能提升</div>
            {% for item in potential_list %}
              <div class="potential">
                <img style="width: 25px;margin-right: 10px"
                     src="../rank/{{ item.potential_rank + 1 }}.png"
                     alt="rank">
                {{ item.potential_desc }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <div>
          <div class="title" style="width: 120px;margin-top: 5px">真名</div>
          {% if op.origin_name and op.origin_name != "未知" %}
            <div>{{ op.origin_name }}</div>
          {% else %}
            <div>未知</div>
          {% endif %}
        </div>

        <div>
          <div class="title" style="width: 120px;margin-top: 5px">CV</div>
          {% if op.cv and op.cv|length %}
            <table>
              {% for lang, names in op.cv.items() %}
                <tr>
                  <td>{{ lang }}：</td>
                  <td>
                    {# op.cv 你现在是 Dict[str,str]；如果你改成 list，也兼容 #}
                    {% if names is string %}
                      {{ names }}
                    {% else %}
                      {{ names|join("、") }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </table>
          {% else %}
            <div>未知</div>
          {% endif %}
        </div>
      </div>

      <div class="operator-name">
        <div class="range" style="margin: 15px 0">
          {% if op_range_html %}
            {{ op_range_html | safe }}
          {% else %}
            {{ op.range or "" }}
          {% endif %}
        </div>

        <div class="class-info">
          <div style="width: 60px;padding: 5px;background: #000">
            <img style="width: 100%"
                 src="../classify/{{ classes_icons.get(op.classes, '') }}"
                 alt="classify">
          </div>
          <div class="rarity">
            <div style="font-size: 30px;display: flex">
              {% for _ in range(op.rarity or 0) %}
                <i>★</i>
              {% endfor %}
            </div>
            <div>{{ op.classes }} - {{ op.classes_sub }}</div>
          </div>
        </div>

        <div class="tags">
          {% if op.is_sp %}
            <span style="background: #9c27b0">异格干员</span>
          {% endif %}
          {% for t in (op.tags or []) %}
            <span>{{ t }}</span>
          {% endfor %}
        </div>

        {# operator_trait 你已经 html_tag_format 过了的话，直接 safe #}
        <div class="trait">{{ (op.operator_trait or "") | safe }}</div>

        <div class="name" style="padding-top: 10px; font-size: 50px">{{ op.name }}</div>
        <div class="name" style="padding-bottom: 10px; font-size: 30px">
          <span>{{ op.number }}</span>
          {{ op.en_name }}
        </div>
      </div>
    </div>

    <div class="right">
      <div>
        <div class="title">干员印象</div>
        <div class="exInfo">{{ op.profile or "无" }}</div>
        <i class="exInfo">「{{ op.impression or "无" }}」</i>
      </div>

      {% if op.potential_item %}
        <div>
          <div class="title">信物</div>
          <div class="exInfo">{{ op.potential_item }}</div>
        </div>
      {% endif %}

      {# talents 目前你接口还是 LIST_STR_DICT，模板按 dict 渲染 #}
      {% if talents_list %}
        <div>
          <div class="title">天赋</div>
          {% for item in talents_list %}
            <div class="exInfo" style="display:flex">
              <div style="width: 120px">{{ item.get("talents_name", "") }}</div>
              <div style="width: calc(100% - 120px);padding-left: 10px">
                {{ (item.get("talents_desc", "") or "") | safe }}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {# 基建技能（如果你后续会传 building_skills） #}
      {% if building_skills %}
        <div>
          <div class="title">基建技能</div>
          {% for item in building_skills %}
            <div class="exInfo bs" style="display:flex">
              <div style="width: 60px">精英{{ item.bs_unlocked }}</div>
              <div class="bs-icon" style="background-image:url('{{ item.bs_icon_url }}')"></div>
              <div style="width: 100px">{{ item.bs_name }}</div>
              <div style="width: calc(100% - 160px);padding-left: 10px">{{ item.bs_desc }}</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {# -------------------- 技能（结构化：op.skills: List[Skill]） -------------------- #}
      {% if op.skills and op.skills|length %}
        <div class="skills">
          {% for sk in op.skills %}
            {% set last = (sk.levels[-1] if sk.levels else None) %}
            <div class="skill-item" style="display:flex">
              <div style="width: 120px;text-align: center">
                <div>
                  <img style="width: 80px"
                       src="{{ skill_icon_url(sk.icon) }}"
                       alt="skill">
                </div>
                <div>{{ sk.name or "" }}</div>
              </div>

              <div style="width: calc(100% - 240px);padding: 0 10px">
                {% if last %}
                  <div class="skill-type" style="margin-bottom: 5px; display:flex; gap:6px;">
                    <div class="t{{ last.sp.sp_type }}">
                      {{ sp_type_name.get(last.sp.sp_type, last.sp.sp_type) }}
                    </div>
                    <div>{{ skill_type_name.get(last.skill_type, last.skill_type) }}</div>
                    {% if last.sp.sp_cost %}
                      <div>技力 {{ last.sp.init_sp }}/{{ last.sp.sp_cost }}</div>
                    {% endif %}
                    {% if last.duration and last.duration > 0 %}
                      <div>持续 {{ last.duration }} 秒</div>
                    {% endif %}
                  </div>

                  <div class="skill-desc">
                    {{ (last.description or "") | safe }}
                  </div>
                {% endif %}
              </div>

              <div class="skill-range">
                {% if last and skill_range_html and skill_range_html.get(sk.skill_id) %}
                  <div>{{ skill_range_html.get(sk.skill_id) | safe }}</div>
                {% elif last %}
                  <div>{{ last.range or "" }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {# -------------------- 模组（结构化：op.modules: List[OperatorModule]） -------------------- #}
      {% if op.modules and op.modules|length %}
        <div style="margin-top: 10px;">
          <div class="title">模组</div>

          {% for m in op.modules %}
            <div class="exInfo" style="margin-bottom: 8px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div style="font-weight:600;">{{ m.name }}</div>
                <div style="opacity:.8;">({{ m.type_name1 }}{% if m.type_name2 %}-{{ m.type_name2 }}{% endif %})</div>
                <div style="opacity:.8;">解锁：{{ m.unlock_evolve_phase }} / Lv.{{ m.unlock_level }}</div>
              </div>

              <div style="margin-top:4px; white-space:pre-wrap;">{{ m.desc }}</div>

              {% if m.level_costs and m.level_costs|length %}
                <div style="margin-top:6px;">
                  <div style="font-weight:600;">升级材料</div>
                  {% for lc in m.level_costs %}
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                      <div style="width:60px;">Lv.{{ lc.level }}</div>
                      <div>
                        {% for c in lc.costs %}
                          {# 这里假设 Cost 子类有 count，MaterialCost 有 material_id #}
                          {% if c.__class__.__name__ == "MaterialCost" %}
                            <span style="margin-right:10px;">{{ c.material_id }} × {{ c.count }}</span>
                          {% else %}
                            <span style="margin-right:10px;">{{ c.__class__.__name__ }} × {{ c.count }}</span>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}

    </div>
  </div>
</div>
</body>
</html>
